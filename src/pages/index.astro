---
import Layout from '@layouts/layout.astro'
import Seo from '@components/seo.astro'
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'
import SkipNavContent from '@components/a11y/skip-nav-content.astro'
import { defaultDateFormat, getPostSlug, sortAsc } from '@utils'
import Link from '@components/link.astro'
import Spacer from '@components/spacer.astro'
import { SITE } from '@constants'
import type { ImageMetadata } from 'astro'

const POSTS_TO_SHOW = 6
const basePath = import.meta.env.BASE_URL.replace(/\/$/, '')

const posts = sortAsc(await getCollection('blog')).slice(0, POSTS_TO_SHOW)
const banners = import.meta.glob('/content/posts/**/*.{jpg,jpeg,png,webp,avif,gif,svg}', { eager: true, import: 'default' }) as Record<string, ImageMetadata>

const getBanner = (entry: (typeof posts)[number]) => {
	if (!entry.data.banner || !entry.filePath) {
		return null
	}

	const bannerPath = entry.data.banner.replace(/^\.?\//, '')
	const basePath = entry.filePath.replace(/\/index\.mdx$/, '/')
	const key = `/${basePath}${bannerPath}`
	return banners[key] ?? null
}

const featuredPosts = posts.map(entry => ({
	entry,
	banner: getBanner(entry),
}))

const getTimeToRead = (body: string) => {
	const words = body.match(/\b[\w'-]+\b/g)?.length ?? 0
	return Math.max(1, Math.ceil(words / 265))
}

const premiumSponsors = [
	{
		name: 'Tanner Linsley',
		url: 'https://tanstack.com/',
		image: 'https://avatars.githubusercontent.com/u/5580297?s=300',
		tier: 'ğŸ’ Platinum',
	},
	{
		name: 'Workleap',
		url: 'https://www.workleap.com',
		image: 'https://avatars.githubusercontent.com/u/53535748?s=300',
		tier: 'ğŸ’ Diamond',
	},
	{
		name: 'wevm',
		url: 'https://wevm.dev/',
		image: 'https://avatars.githubusercontent.com/u/109633172?s=300',
		tier: 'ğŸ¥‡ Gold',
	},
	{
		name: 'React Bricks',
		url: 'https://reactbricks.com/',
		image: '/images/reactbricks.svg',
		tier: 'ğŸ¥‰ Bronze',
	},
]
---

<Layout>
	<Seo slot="seo" />
	<SkipNavContent>
		<h1 class="sr-only">{SITE.title}</h1>
		<section>
			<div class="grid grid-cols-1 md:grid-cols-[19rem_minmax(0,25rem)] gap-4 items-center max-w-[50rem]">
				<div class="w-60 md:w-76">
					<img
						src="https://avatars.githubusercontent.com/u/1021430?s=400"
						alt="TkDodo"
						class="rounded-full w-full h-auto"
					/>
				</div>
				<div class="max-w-full md:max-w-[25rem]">
					<h2 class="text-2xl md:text-3xl lg:text-4xl text-highlight leading-tight">Hi ğŸ‘‹, I&apos;m Dominik from Vienna ğŸ‡¦ğŸ‡¹</h2>
					<p class="mt-4 text-base md:text-lg">
						I&apos;m a Web Developer and open source maintainer who â¤ï¸ ReactJs and TypeScript. I&apos;m currently maintaining
						<a class="text-primary hover:underline" href="https://github.com/TanStack/query" target="_blank" rel="noreferrer noopener"> TanStack/query </a>
						and
						<a class="text-primary hover:underline" href="https://github.com/TanStack/router" target="_blank" rel="noreferrer noopener"> TanStack/router</a>.
					</p>
				</div>
			</div>
			<p class="mt-6 text-base md:text-lg">
				Welcome to my personal blog ğŸ“š, where I write about all things React, TypeScript and of course the
				<a class="text-primary hover:underline" href="https://github.com/TanStack" target="_blank" rel="noreferrer noopener"> TanStack</a>.
				If you enjoy my blog posts or want to support my open source work, you can
				<a class="text-primary hover:underline whitespace-nowrap" href="https://github.com/sponsors/TkDodo" target="_blank" rel="noopener noreferrer">
					ğŸ— sponsor me on Github ğŸ—
				</a>
			</p>
		</section>
		<Spacer axis="vertical" size={32} />
		<section>
			<div class="border-b border-border pb-4 flex justify-between items-center">
				<h2 class="font-medium text-xl md:text-2xl lg:text-3xl text-highlight">Latest Posts</h2>
				<div><Link href="/all">Read all posts</Link></div>
			</div>
			<Spacer axis="vertical" size={8} />
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
			{
				featuredPosts.map(({ entry, banner }) => (
					<div class="max-w-80 mx-auto lg:max-w-none w-full border-2 border-transparent rounded-xl p-2 hover:border-primary focus-within:border-primary transition-all duration-200 ease-in motion-safe:hover:-translate-y-2">
						{banner && (
							<a href={`${basePath}/${getPostSlug(entry)}`} tabIndex={-1}>
								<Image src={banner} width={300} height={200} alt={entry.data.title} class="rounded-md w-full h-auto" />
							</a>
						)}
						<p class="mt-2 mb-1 text-subtle text-base lg:text-lg leading-normal">
							<time>{defaultDateFormat(entry.data.date)}</time>, {getTimeToRead(entry.body)} min read
						</p>
						<div class="mt-2 font-semibold text-base md:text-lg lg:text-xl leading-normal">
							<Link variant="subtle" underlineOnHover={false} class="text-text" href={`/${getPostSlug(entry)}`}>
								{entry.data.title}
							</Link>
						</div>
					</div>
				))
			}
			</div>
		</section>
		<Spacer axis="vertical" size={32} />
		<section>
			<div class="border-b border-border pb-4 flex justify-between items-center">
				<h2 class="font-medium text-xl md:text-2xl lg:text-3xl text-highlight">Premium Sponsors</h2>
				<div><Link href="/sponsors">See all sponsors</Link></div>
			</div>
			<Spacer axis="vertical" size={8} />
			<div class="mb-6">
				<a href="https://github.com/sponsors/TkDodo" target="_blank" rel="noopener noreferrer" class="text-subtle hover:underline hover:text-highlight">
					ğŸ— Sponsor me on GitHub ğŸ—
				</a>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-5">
				{
					premiumSponsors.map((sponsor) => (
						<article class="rounded-xl border border-border p-4 bg-bg">
							<a href={sponsor.url} target="_blank" rel="noopener noreferrer" class="block">
								<h3 class="text-highlight text-lg md:text-xl mb-3">{sponsor.name}</h3>
								<img src={sponsor.image} alt={sponsor.name} loading="lazy" class="w-full h-52 object-cover rounded-md bg-white" />
							</a>
							<p class="mt-3 text-subtle">{sponsor.tier}</p>
						</article>
					))
				}
			</div>
		</section>
		<Spacer axis="vertical" size={32} />
	</SkipNavContent>
</Layout>
