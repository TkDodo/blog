---
import Layout from "@layouts/layout.astro";
import Seo from "@components/seo.astro";
import { getCollection } from "astro:content";
import SkipNavContent from "@components/a11y/skip-nav-content.astro";
import { sortAsc } from "@utils";
import Link from "@components/link.astro";
import Spacer from "@components/spacer.astro";
import PostCard from "@components/post-card.astro";
import { SITE } from "@constants";
import type { ImageMetadata } from "astro";

const POSTS_TO_SHOW = 6;

const posts = sortAsc(await getCollection("blog")).slice(0, POSTS_TO_SHOW);
const banners = import.meta.glob(
  "/content/posts/**/*.{jpg,jpeg,png,webp,avif,gif,svg}",
  { eager: true, import: "default" },
) as Record<string, ImageMetadata>;

const getBanner = (entry: (typeof posts)[number]) => {
  if (!entry.data.banner || !entry.filePath) {
    return null;
  }

  const bannerPath = entry.data.banner.replace(/^\.?\//, "");
  const basePath = entry.filePath.replace(/\/index\.mdx$/, "/");
  const key = `/${basePath}${bannerPath}`;
  return banners[key] ?? null;
};

const featuredPosts = posts.map((entry) => ({
  entry,
  banner: getBanner(entry),
}));

const premiumSponsors = [
  {
    name: "Tanner Linsley",
    label: "üíç Tanner Linsley",
    url: "https://tanstack.com/",
    image: "https://avatars.githubusercontent.com/u/5580297?s=64",
  },
  {
    name: "Workleap",
    label: "üíé Workleap",
    url: "https://www.workleap.com",
    image: "https://avatars.githubusercontent.com/u/53535748?s=64",
  },
  {
    name: "wevm",
    label: "ü•á wevm",
    url: "https://wevm.dev/",
    image: "https://avatars.githubusercontent.com/u/109633172?s=64",
  },
  {
    name: "React Bricks",
    label: "ü•â React Bricks",
    url: "https://reactbricks.com/",
    image: "/images/reactbricks.svg",
  },
  {
    name: "WorkflowGen",
    label: "ü•≥ WorkflowGen",
    url: "https://www.workflowgen.com/",
    image: "/images/workflowgen.png",
  },
  {
    name: "Jonas Daniels",
    label: "ü•≥ Jonas Daniels",
    url: "https://github.com/jnsdls",
    image: "https://avatars.githubusercontent.com/u/8204858?s=64",
  },
  {
    name: "MonoLisa",
    label: "ü•≥ MonoLisa",
    url: "https://www.monolisa.dev/?ref=dominik",
    image: "/images/monolisa.jpeg",
  },
  {
    name: "Nadav Lebovitch",
    label: "ü•≥ Nadav Lebovitch",
    url: "https://github.com/nadavl",
    image: "https://avatars.githubusercontent.com/u/5332234?s=64",
  },
  {
    name: "Jeremy Brown",
    label: "ü•≥ Jeremy Brown",
    url: "https://github.com/jlbmagic",
    image: "https://avatars.githubusercontent.com/u/20194907?s=64",
  },
  {
    name: "deliver.media",
    label: "ü•≥ deliver.media",
    url: "https://deliver.media/",
    image: "https://avatars.githubusercontent.com/u/120005519?s=64",
  },
];
const basePath = import.meta.env.BASE_URL.replace(/\/$/, "");
const withBasePath = (url: string) =>
  url.startsWith("/") ? `${basePath}${url}` : url;
---

<Layout>
  <Seo slot="seo" />
  <SkipNavContent>
    <h1 class="sr-only">{SITE.title}</h1>
    <section>
      <div
        class="grid grid-cols-1 md:grid-cols-[19rem_minmax(0,25rem)] gap-4 items-center max-w-[50rem]"
      >
        <div class="w-60 md:w-76">
          <img
            src="https://avatars.githubusercontent.com/u/1021430?s=400"
            alt="TkDodo"
            class="rounded-full w-full h-auto"
          />
        </div>
        <div class="max-w-full md:max-w-[25rem]">
          <h2
            class="text-2xl md:text-3xl lg:text-4xl text-highlight leading-tight"
          >
            Hi üëã, I&apos;m Dominik from Vienna üá¶üáπ
          </h2>
          <p class="mt-4 text-base md:text-lg">
            I&apos;m a Web Developer and open source maintainer who ‚ù§Ô∏è ReactJs
            and TypeScript. I&apos;m currently maintaining
            <a
              class="text-primary hover:underline"
              href="https://github.com/TanStack/query"
              target="_blank"
              rel="noreferrer noopener"
            >
              TanStack/query
            </a>
            and
            <a
              class="text-primary hover:underline"
              href="https://github.com/TanStack/router"
              target="_blank"
              rel="noreferrer noopener"
            >
              TanStack/router</a
            >.
          </p>
        </div>
      </div>
      <p class="mt-6 text-base md:text-lg">
        Welcome to my personal blog üìö, where I write about all things React,
        TypeScript and of course the
        <a
          class="text-primary hover:underline"
          href="https://github.com/TanStack"
          target="_blank"
          rel="noreferrer noopener"
        >
          TanStack</a
        >. If you enjoy my blog posts or want to support my open source work,
        you can
        <a
          class="text-primary hover:underline whitespace-nowrap"
          href="https://github.com/sponsors/TkDodo"
          target="_blank"
          rel="noopener noreferrer"
        >
          üéó sponsor me on Github üéó
        </a>
      </p>
    </section>
    <Spacer axis="vertical" size={32} />
    <section>
      <div
        class="border-b border-border pb-4 flex justify-between items-center"
      >
        <h2 class="font-medium text-xl md:text-2xl lg:text-3xl text-highlight">
          Latest Posts
        </h2>
        <div><Link href="/all">Read all posts</Link></div>
      </div>
      <Spacer axis="vertical" size={8} />
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5"
      >
        {
          featuredPosts.map(({ entry, banner }) => (
            <PostCard entry={entry} banner={banner} />
          ))
        }
      </div>
    </section>
    <Spacer axis="vertical" size={32} />
    <section>
      <div
        class="border-b border-border pb-4 flex justify-between items-center"
      >
        <h2 class="font-medium text-xl md:text-2xl lg:text-3xl text-highlight">
          Premium Sponsors
        </h2>
        <div><Link href="/sponsors">See all sponsors</Link></div>
      </div>
      <Spacer axis="vertical" size={8} />
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
        {
          premiumSponsors.map((sponsor) => (
            <div class="flex items-center">
              <img
                src={withBasePath(sponsor.image)}
                alt={sponsor.name}
                loading="lazy"
                class="mr-3.5 w-16 h-16 rounded-full object-cover bg-white"
              />
              <a
                href={sponsor.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-lg md:text-lg lg:text-xl leading-normal text-primary hover:underline"
              >
                {sponsor.label}
              </a>
            </div>
          ))
        }
      </div>
    </section>
    <Spacer axis="vertical" size={32} />
  </SkipNavContent>
</Layout>
