---
import type { ImageMetadata } from "astro";
import type { TocName } from "components/series-data";
import SkipNavContent from "@components/a11y/skip-nav-content.astro";
import Aside from "@components/aside.astro";
import Link from "@components/link.astro";
import Playground from "@components/playground.astro";
import ProgressiveImage from "@components/progressive-image.astro";
import Prose from "@components/prose.astro";
import Seo from "@components/seo.astro";
import Spacer from "@components/spacer.astro";
import TagLinks from "@components/tag-links.astro";
import { SITE } from "@constants";
import Layout from "@layouts/layout.astro";
import { defaultDateFormat, getPostSlug, isoDateFormat, sortAsc } from "@utils";
import { getCollection, render } from "astro:content";
import ErrorBoundary from "components/ErrorBoundary";
import RepoData from "components/RepoData";
import { seriesByToc } from "components/series-data";
import Suspense from "components/Suspense";

export async function getStaticPaths() {
  const entries = await getCollection("blog");

  return entries.map((e) => ({
    params: {
      blog: getPostSlug(e),
    },
    props: {
      entry: e,
    },
  }));
}

const { entry } = Astro.props;
const { data: post } = entry;
const postSlug = getPostSlug(entry);
const { Content } = await render(entry);

const allPosts = sortAsc(await getCollection("blog"));
const detectedToc = entry.body?.match(
  /<(RqToc|DsToc|UsToc|TsrToc|HsToc|RcToc|RtrToc)\b/,
)?.[1] as TocName | undefined;
const seriesItems = detectedToc ? seriesByToc[detectedToc] : null;
const currentSeriesIndex =
  seriesItems?.findIndex((item) => item.id === postSlug) ?? -1;
const previousSeriesSlug =
  currentSeriesIndex > 0
    ? (seriesItems?.[currentSeriesIndex - 1]?.id ?? null)
    : null;
const nextSeriesSlug =
  currentSeriesIndex >= 0
    ? (seriesItems?.[currentSeriesIndex + 1]?.id ?? null)
    : null;

const previousSeriesPost = previousSeriesSlug
  ? (allPosts.find((p) => getPostSlug(p) === previousSeriesSlug) ?? null)
  : null;
const nextSeriesPost = nextSeriesSlug
  ? (allPosts.find((p) => getPostSlug(p) === nextSeriesSlug) ?? null)
  : null;
const hasTableOfContents = Boolean(detectedToc);

const banners = import.meta.glob<ImageMetadata>(
  "/content/posts/**/*.{avif,gif,jpeg,jpg,png,webp}",
  {
    eager: true,
    import: "default",
  },
);

const getBannerForEntry = (
  blogEntry: (typeof allPosts)[number] | null | undefined,
): ImageMetadata | null => {
  if (!blogEntry?.filePath || !blogEntry.data.banner) return null;

  const basePath = blogEntry.filePath.replace(/\/index\.mdx$/, "/");
  const bannerPath = blogEntry.data.banner.replace(/^\.?\//, "");
  const key = `/${basePath}${bannerPath}`;

  return banners[key] ?? null;
};

const postBanner = getBannerForEntry(entry);
const previousPostBanner = getBannerForEntry(previousSeriesPost);
const nextPostBanner = getBannerForEntry(nextSeriesPost);

const POST_BANNER_MAX_WIDTH = 760;
const postBannerRenderWidth = postBanner
  ? Math.min(postBanner.width, POST_BANNER_MAX_WIDTH)
  : POST_BANNER_MAX_WIDTH;
const postBannerRenderHeight = postBanner
  ? Math.round((postBanner.height / postBanner.width) * postBannerRenderWidth)
  : Math.round((2 / 3) * POST_BANNER_MAX_WIDTH);
const ogImagePath = `${import.meta.env.BASE_URL.replace(/\/$/, "")}/og-images/${postSlug}.png`;
---

<Layout>
  <Seo
    slot="seo"
    forceTitle={post.title}
    description={post.description}
    image={ogImagePath}
  >
    <meta name="twitter:label1" value="Author" />
    <meta
      name="twitter:data1"
      data-pagefind-meta="author"
      value={SITE.defaultAuthor}
    />
    <meta name="twitter:label2" value="Tags" />
    <meta name="twitter:data2" value={(post.tags ?? []).join(", ")} />
    <meta
      name="article:published_time"
      data-pagefind-meta="published_time"
      content={isoDateFormat(post.date)}
    />
    <meta
      name="article:modified_time"
      data-pagefind-meta="modified_time"
      content={isoDateFormat(post.date)}
    />
  </Seo>
  <SkipNavContent searchIndex={post.searchIndex}>
    <Prose>
      <h1
        class="mb-0! font-bold! leading-[1.25]! md:leading-[1.25]! lg:leading-[1.25]!"
        data-pagefind-meta="title"
      >
        {post.title}
      </h1>
      <Spacer axis="vertical" size={4} />
      <div class="not-prose text-faded text-sm md:text-base leading-relaxed">
        {defaultDateFormat(post.date)} â€” <TagLinks tags={post.tags ?? []} />
      </div>
      <Spacer axis="vertical" size={12} />
      {
        postBanner && (
          <>
            <ProgressiveImage
              src={postBanner}
              alt={post.title}
              width={postBannerRenderWidth}
              height={postBannerRenderHeight}
              sizes="(max-width: 768px) calc(100vw - 2rem), 760px"
              fill={false}
              loading="eager"
              fetchpriority="high"
              wrapperClass="mx-auto w-full rounded-lg"
              wrapperStyle={`max-width:${postBannerRenderWidth}px;`}
              imageClass="mx-auto block h-auto w-full"
            />
            <Spacer axis="vertical" size={12} />
          </>
        )
      }
      <Content
        components={{
          Aside,
          Playground,
          RepoData,
          Suspense,
          ErrorBoundary,
        }}
      />
      {
        hasTableOfContents && (previousSeriesPost || nextSeriesPost) && (
          <>
            <Spacer axis="vertical" size={32} />
            <section id="read-next-callout" class="not-prose">
              <h2 class="mb-3 text-sm font-semibold tracking-[0.06em] uppercase text-subtle">
                Continue Series
              </h2>
              <div
                class:list={[
                  "grid gap-3",
                  previousSeriesPost && nextSeriesPost
                    ? "grid-cols-2 gap-2"
                    : "grid-cols-1",
                ]}
              >
                {previousSeriesPost && (
                  <Link
                    href={`/${getPostSlug(previousSeriesPost)}`}
                    variant="subtle"
                    underlineOnHover={false}
                    class="group block rounded-xl border border-border bg-ic-bg/45 p-2 md:p-3 transition-colors duration-200 hover:border-primary"
                  >
                    <p class="text-[0.625rem] font-semibold tracking-[0.06em] uppercase text-subtle">
                      Previous
                    </p>
                    <div class="mt-1 flex items-center gap-2 md:gap-3">
                      {previousPostBanner && (
                        <div class="h-12 w-12 shrink-0 overflow-hidden rounded-md md:h-16 md:w-16">
                          <ProgressiveImage
                            src={previousPostBanner}
                            alt={previousSeriesPost.data.title}
                            width={96}
                            height={96}
                            sizes="(max-width: 768px) 48px, 64px"
                            wrapperClass="h-full w-full"
                          />
                        </div>
                      )}
                      <div class="min-w-0">
                        <p class="text-sm font-semibold leading-tight text-text group-hover:text-text md:text-base">
                          {previousSeriesPost.data.title}
                        </p>
                      </div>
                    </div>
                  </Link>
                )}
                {nextSeriesPost && (
                  <Link
                    href={`/${getPostSlug(nextSeriesPost)}`}
                    variant="subtle"
                    underlineOnHover={false}
                    class="group block rounded-xl border border-border bg-ic-bg/45 p-2 md:p-3 transition-colors duration-200 hover:border-primary"
                  >
                    <p class="text-[0.625rem] font-semibold tracking-[0.06em] uppercase text-subtle">
                      Next
                    </p>
                    <div class="mt-1 flex items-center gap-2 md:gap-3">
                      {nextPostBanner && (
                        <div class="h-12 w-12 shrink-0 overflow-hidden rounded-md md:h-16 md:w-16">
                          <ProgressiveImage
                            src={nextPostBanner}
                            alt={nextSeriesPost.data.title}
                            width={96}
                            height={96}
                            sizes="(max-width: 768px) 48px, 64px"
                            wrapperClass="h-full w-full"
                          />
                        </div>
                      )}
                      <div class="min-w-0">
                        <p class="text-sm font-semibold leading-tight text-text group-hover:text-text md:text-base">
                          {nextSeriesPost.data.title}
                        </p>
                      </div>
                    </div>
                  </Link>
                )}
              </div>
            </section>
          </>
        )
      }
      <script is:inline>
        (() => {
          const placeCalloutBeforeComments = () => {
            const callout = document.getElementById("read-next-callout");
            if (!callout) return;

            const giscusRoot = document.querySelector(".giscus");
            const commentsSection = giscusRoot?.closest("section");
            if (!commentsSection?.parentElement) return;
            if (callout.nextElementSibling === commentsSection) return;

            commentsSection.parentElement.insertBefore(
              callout,
              commentsSection,
            );
          };

          document.addEventListener(
            "astro:page-load",
            placeCalloutBeforeComments,
          );
          placeCalloutBeforeComments();
        })();
      </script>
    </Prose>
  </SkipNavContent>
</Layout>
