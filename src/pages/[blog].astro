---
import { getCollection, render } from "astro:content";
import Seo from "@components/seo.astro";
import Layout from "@layouts/layout.astro";
import Prose from "@components/prose.astro";
import { SITE } from "@constants";
import { defaultDateFormat, getPostSlug, isoDateFormat } from "@utils";
import SkipNavContent from "@components/a11y/skip-nav-content.astro";
import Spacer from "@components/spacer.astro";
import Aside from "@components/aside.astro";
import TagLinks from "@components/tag-links.astro";
import Playground from "@components/playground.astro";
import ProgressiveImage from "@components/progressive-image.astro";
import RepoData from "components/RepoData";
import Suspense from "components/Suspense";
import ErrorBoundary from "components/ErrorBoundary";

export async function getStaticPaths() {
  const entries = await getCollection("blog");

  return entries.map((e) => ({
    params: {
      blog: getPostSlug(e),
    },
    props: {
      entry: e,
    },
  }));
}

const { entry } = Astro.props;
const { data: post } = entry;
const postSlug = getPostSlug(entry);
const { Content } = await render(entry);
const banners = import.meta.glob(
  "/content/posts/**/*.{avif,gif,jpeg,jpg,png,webp}",
  {
    eager: true,
    import: "default",
  },
);
const postBanner = (() => {
  if (!entry.filePath || !post.banner) return null;

  const basePath = entry.filePath.replace(/\/index\.mdx$/, "/");
  const bannerPath = post.banner.replace(/^\.?\//, "");
  const key = `/${basePath}${bannerPath}`;

  return banners[key] ?? null;
})();
const POST_BANNER_MAX_WIDTH = 760;
const postBannerRenderWidth = postBanner
  ? Math.min(postBanner.width, POST_BANNER_MAX_WIDTH)
  : POST_BANNER_MAX_WIDTH;
const postBannerRenderHeight = postBanner
  ? Math.round((postBanner.height / postBanner.width) * postBannerRenderWidth)
  : Math.round((2 / 3) * POST_BANNER_MAX_WIDTH);
const ogImagePath = `${import.meta.env.BASE_URL.replace(/\/$/, "")}/og-images/${postSlug}.png`;
---

<Layout>
  <Seo
    slot="seo"
    forceTitle={post.title}
    description={post.description}
    image={ogImagePath}
  >
    <meta name="twitter:label1" value="Author" />
    <meta
      name="twitter:data1"
      data-pagefind-meta="author"
      value={SITE.defaultAuthor}
    />
    <meta name="twitter:label2" value="Tags" />
    <meta name="twitter:data2" value={(post.tags ?? []).join(", ")} />
    <meta
      name="article:published_time"
      data-pagefind-meta="published_time"
      content={isoDateFormat(post.date)}
    />
    <meta
      name="article:modified_time"
      data-pagefind-meta="modified_time"
      content={isoDateFormat(post.date)}
    />
  </Seo>
  <SkipNavContent searchIndex={post.searchIndex}>
    <Prose>
      <h1
        class="mb-0! font-bold! leading-[1.25]! md:leading-[1.25]! lg:leading-[1.25]!"
        data-pagefind-meta="title"
      >
        {post.title}
      </h1>
      <Spacer axis="vertical" size={4} />
      <div class="not-prose text-faded text-sm md:text-base leading-relaxed">
        {defaultDateFormat(post.date)} â€” <TagLinks tags={post.tags ?? []} />
      </div>
      <Spacer axis="vertical" size={12} />
      {
        postBanner && (
          <>
            <ProgressiveImage
              src={postBanner}
              alt={post.title}
              width={postBannerRenderWidth}
              height={postBannerRenderHeight}
              sizes="(max-width: 768px) calc(100vw - 2rem), 760px"
              fill={false}
              loading="eager"
              fetchpriority="high"
              wrapperClass="mx-auto w-fit max-w-full rounded-lg"
              imageClass="mx-auto block h-auto w-auto max-w-full"
            />
            <Spacer axis="vertical" size={8} />
          </>
        )
      }
      <Content
        components={{
          Aside,
          Playground,
          RepoData,
          Suspense,
          ErrorBoundary,
        }}
      />
    </Prose>
  </SkipNavContent>
</Layout>
