---
import type { ImageMetadata } from "astro";
import SkipNavContent from "@components/a11y/skip-nav-content.astro";
import Link from "@components/link.astro";
import PostCard from "@components/post-card.astro";
import Seo from "@components/seo.astro";
import Spacer from "@components/spacer.astro";
import Layout from "@layouts/layout.astro";
import { sortAsc } from "@utils";
import { getCollection } from "astro:content";

const posts = sortAsc(await getCollection("blog"));
const banners = import.meta.glob(
  "/content/posts/**/*.{jpg,jpeg,png,webp,avif,gif,svg}",
  { eager: true, import: "default" },
) as Record<string, ImageMetadata>;

const getBanner = (entry: (typeof posts)[number]) => {
  if (!entry.data.banner || !entry.filePath) {
    return null;
  }

  const bannerPath = entry.data.banner.replace(/^\.?\//, "");
  const basePath = entry.filePath.replace(/\/index\.mdx$/, "/");
  const key = `/${basePath}${bannerPath}`;
  return banners[key] ?? null;
};

const allPosts = posts.map((entry) => ({
  entry,
  banner: getBanner(entry),
}));
---

<Layout>
  <Seo slot="seo" title="Blog" />
  <SkipNavContent>
    <div class="flex justify-between items-center">
      <h1 class="font-medium text-xl md:text-2xl lg:text-3xl text-highlight">
        Blog
      </h1>
      <div><Link href="/tags">View all tags</Link></div>
    </div>
    <Spacer axis="vertical" size={8} />
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
      {
        allPosts.map(({ entry, banner }) => (
          <PostCard entry={entry} banner={banner} showTags />
        ))
      }
    </div>
    <Spacer axis="vertical" size={16} />
  </SkipNavContent>
</Layout>
